{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sách - Library SOA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Chi tiết sách</h4>
                    <a href="/" class="btn btn-secondary">← Quay lại</a>
                </div>
                <div class="card-body">
                    {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                    {% elif book %}
                        <div id="bookInfo">
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>ID:</strong></div>
                                <div class="col-sm-9">{{ book.id }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Tên sách:</strong></div>
                                <div class="col-sm-9">
                                    <span id="title-display">{{ book.title }}</span>
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="editField('title')">Sửa</button>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Tác giả:</strong></div>
                                <div class="col-sm-9">
                                    <span id="author-display">{{ book.author }}</span>
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="editField('author')">Sửa</button>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-3"><strong>Trạng thái:</strong></div>
                                <div class="col-sm-9">
                                    <span id="available-display" class="badge {{ book.available|yesno:'bg-success,bg-danger' }}">
                                        {{ book.available|yesno:'Có sẵn,Không có sẵn' }}
                                    </span>
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleAvailable()">Thay đổi</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-danger" onclick="deleteBook({{ book.id }})">Xóa sách</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const bookId = {{ book.id|default:"null" }};
let currentAvailable = {{ book.available|yesno:"true,false"|default:"null" }};

async function editField(field) {
    const currentValue = document.getElementById(field + '-display').textContent;
    const newValue = prompt(`Nhập ${field === 'title' ? 'tên sách' : 'tác giả'} mới:`, currentValue);
    
    if (newValue && newValue !== currentValue) {
        try {
            const response = await fetch(`/api/book/books/${bookId}/`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: newValue })
            });
            
            if (response.ok) {
                document.getElementById(field + '-display').textContent = newValue;
                alert('Cập nhật thành công!');
            } else {
                alert('Lỗi khi cập nhật!');
            }
        } catch (error) {
            alert('Lỗi kết nối!');
        }
    }
}

async function toggleAvailable() {
    const newAvailable = !currentAvailable;
    const confirmText = newAvailable ? 'Đánh dấu sách là có sẵn?' : 'Đánh dấu sách là không có sẵn?';
    
    if (confirm(confirmText)) {
        try {
            const response = await fetch(`/api/book/books/${bookId}/`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ available: newAvailable })
            });
            
            if (response.ok) {
                currentAvailable = newAvailable;
                const badge = document.getElementById('available-display');
                badge.textContent = newAvailable ? 'Có sẵn' : 'Không có sẵn';
                badge.className = `badge ${newAvailable ? 'bg-success' : 'bg-danger'}`;
                alert('Cập nhật thành công!');
            } else {
                alert('Lỗi khi cập nhật!');
            }
        } catch (error) {
            alert('Lỗi kết nối!');
        }
    }
}

async function deleteBook(id) {
    if (confirm('Bạn có chắc chắn muốn xóa sách này?')) {
        try {
            const response = await fetch(`/api/book/books/${id}/`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Xóa thành công!');
                window.location.href = '/';
            } else {
                alert('Lỗi khi xóa!');
            }
        } catch (error) {
            alert('Lỗi kết nối!');
        }
    }
}
</script>
</body>
</html>
